<script>
async function analyze() {
  const fileInput = document.getElementById("file");
  const status = document.getElementById("status");
  const result = document.getElementById("result");

  if (!fileInput.files.length) return;

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  status.innerText = "⏳ กำลังวิเคราะห์เอกสารด้วย Typhoon...";
  result.innerHTML = "";

  const res = await fetch("/analyze", {
    method: "POST",
    body: formData
  });

  const data = await res.json();

  status.innerText = "✅ วิเคราะห์เสร็จแล้ว";

  // JSON
  result.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;

  // ตารางสินค้า
  if (data.analysis?.data?.items?.length) {
    let table = "<table border='1'><tr><th>สินค้า</th><th>จำนวน</th><th>ราคา</th></tr>";
    data.analysis.data.items.forEach(i => {
      table += `<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.price}</td></tr>`;
    });
    table += "</table>";
    result.innerHTML += table;
  }

  // VAT Warning
  const a = data.analysis?.data?.amount;
  if (a && Math.abs(a.subtotal * a.vat_rate / 100 - a.vat_amount) > 1) {
    result.innerHTML += "<p style='color:red'>⚠️ VAT ไม่ตรง</p>";
  }
}
</script>
